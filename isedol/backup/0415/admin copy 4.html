<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Admin 페이지</title>
    <script src="https://unpkg.com/vue@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
      :root { --main-color: #9b59b6; }
      /* 기본 스타일 초기화 및 폰트 설정 */ 
      body { margin: 0; font-family: Arial, sans-serif; background-color: black; color: white; } 
      /* 로그인/회원가입 페이지 스타일 */ 
      .auth-container { max-width: 400px; margin: 100px auto; background: #fff; padding: 30px; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); text-align: center; } 
      .auth-container input { width: calc(100% - 20px); padding: 8px 10px; margin: 10px 0; font-size: 16px; } 
      .auth-container button { padding: 10px 15px; font-size: 16px; margin: 10px 5px; cursor: pointer; } 
      .dup-check-btn { margin-left: 5px; padding: 8px 12px; font-size: 14px; } 
      /* 좌측 사이드바 */ 
      .sidebar { position: fixed; top: 0; left: 0; width: 200px; height: 100vh; 
        background-color: #000; color: #fff; overflow-y: auto; padding: 10px; 
        z-index: 100; display: flex; flex-direction: column; justify-content: space-between; 
        border-right: 2px solid var(--main-color); box-shadow: 10px 0 10px rgba(255, 255, 255, 0.3);} 
      .table-list { flex-grow: 1; } 
      .table-button { display: block; width: 100%; padding: 8px; margin-bottom: 10px; background-color: #333; border: none; color: #fff; text-align: left; cursor: pointer; } 
      .table-button:hover { background-color: #555; } 
      .logout-button { padding: 10px; background-color: #dc3545; border: none; color: #fff; width: 100%; cursor: pointer; margin-top: 10px; } 
      /* 우측 콘텐츠 영역 */ 
      .content { margin-left: 220px; padding: 20px; position: relative; } 
      .plus-button { position: absolute; top: 20px; right: 20px; padding: 10px 15px; background-color: var(--main-color); color: #fff; border: none; cursor: pointer; font-size: 18px; } 
      table { width: 100%; border-collapse: collapse; } 
      thead th { background: var(--main-color); padding: 10px; border: 1px solid #ccc; } 
      tbody td { padding: 8px; border: 1px solid #ccc; text-align: left; } 
      .action-button { margin: 0 3px; padding: 5px 10px; border: none; cursor: pointer; } 
      .edit-button { background-color: #007bff; color: #fff; } 
      .delete-button { background-color: #dc3545; color: #fff; } 
      .pagination { margin-top: 15px; text-align: center; } 
      .pagination button { margin: 0 10px; padding: 5px 10px; cursor: pointer; } 
      /* 수정폼 스타일 */ 
      .edit-form { max-width: 600px; margin: auto; position: relative; } 
      .edit-form table { width: 100%; } 
      .edit-form td { padding: 5px; vertical-align: top; } 
      .edit-form input { width: 100%; padding: 5px; box-sizing: border-box; } 
      .save-button, .list-button { margin-top: 15px; padding: 10px 15px; border: none; cursor: pointer; font-size: 16px; display: inline-block; width: 48%; } 
      .save-button { background-color: blue; color: #fff; } 
      .list-button { background-color: gray; color: #fff; margin-right: 4%; } 
      /* 전체삭제 버튼 (수정페이지 우측 상단) */ 
      .delete-all-button { position: absolute; right: 0; padding: 10px 15px; 
        background-color: red; color: #fff; border: none; cursor: pointer; font-size: 16px; 

      } 
      /* 파일 미리보기 */ 
      .img-preview { max-width: 100px; margin-top: 10px; }
    </style>
  </head>
  <body>
    <div id="app">
      <!-- 로그인 페이지 -->
      <div v-if="currentView === 'login'" class="auth-container">
        <h2>로그인</h2>
        <div>
          <input type="text" v-model="loginId" placeholder="아이디(이메일)" />
        </div>
        <div>
          <input type="password" v-model="loginPw" placeholder="비밀번호" />
        </div>
        <div>
          <button @click="loginUser">Login</button>
          <button @click="goToSignup">회원가입</button>
        </div>
      </div>

      <!-- 회원가입 페이지 -->
      <div v-if="currentView === 'signup'" class="auth-container">
        <h2>회원가입</h2>
        <div style="text-align: left">
          <label>이메일</label>
          <div style="display: flex; align-items: center">
            <input type="text" v-model="signupEmail" placeholder="이메일" />
          </div>
        </div>
        <div>
          <input type="password" v-model="signupPw" placeholder="비밀번호" />
        </div>
        <div>
          <button @click="signupUser">회원가입</button>
          <button @click="goToLogin">취소</button>
        </div>
      </div>

      <!-- 리스트 페이지 -->
      <div v-if="currentView === 'list'">
        <!-- 좌측 사이드바 -->
        <div class="sidebar">
          <div class="table-list">
            <span style="display: block; margin-bottom: 15px"
              >LOGIN<br />{{ userEmail }}</span
            >
            <h3>테이블 목록</h3>
            <div v-for="table in tables" :key="table">
              <button class="table-button" @click="selectTable(table)">
                {{ table }}
              </button>
            </div>
            <button class="logout-button" @click="logoutUser">LogOut</button>
          </div>
        </div>
        <!-- 우측 리스트 콘텐츠 -->
        <div class="content">
          <button class="plus-button" @click="newRow">+</button>
          <div v-if="selectedTable">
            <h2>{{ selectedTable }} - 데이터</h2>
            <table v-if="tableData.length > 0">
              <thead>
                <tr>
                  <th v-for="col in tableColumns" :key="col">{{ col }}</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(row, index) in tableData" :key="row[idx] || index">
                  <td v-for="col in tableColumns" :key="col">{{ row[col] }}</td>
                  <td>
                    <button
                      class="action-button edit-button"
                      @click="goToEdit(row, false)"
                    >
                      Edit
                    </button>
                    <button
                      class="action-button delete-button"
                      @click="deleteRow(row)"
                    >
                      Delete
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
            <div v-else>
              <p>데이터가 없습니다.</p>
            </div>
            <!-- 페이지네이션 -->
            <div class="pagination">
              <button @click="prevPage" :disabled="currentPage === 1">
                Prev
              </button>
              <span>{{ currentPage }} / {{ totalPages }}</span>
              <button @click="nextPage" :disabled="currentPage === totalPages">
                Next
              </button>
            </div>
          </div>
          <div v-else>
            <h2>테이블을 선택하세요.</h2>
          </div>
        </div>
      </div>
      <!-- 수정/추가 페이지 -->
      <div v-if="currentView === 'edit'" class="content">
        <div class="edit-form">
          <!-- 전체삭제 버튼: 현재 테이블의 모든 행을 삭제 -->
          <button class="delete-all-button" @click="deleteAllRows">
            전체삭제
          </button>
          <h2>
            {{ isNew ? "새로운 row 추가" : "데이터 수정" }} - {{ selectedTable
            }}
          </h2>
          <table>
            <tbody>
              <tr v-for="(value, key) in editRowData" :key="key">
                <td><strong>{{ key }}</strong></td>
                <td>
                  <!-- 파일 입력: 컬럼명이 img 혹은 thumbnail 인 경우 -->
                  <template v-if="key === 'img' || key === 'thumbnail'">
                    <input
                      type="file"
                      @change="handleFileChange($event, key)"
                      accept="image/*"
                    />
                    <div v-if="filePreviews[key]">
                      <img
                        :src="filePreviews[key]"
                        alt="Preview"
                        class="img-preview"
                      />
                    </div>
                    <div v-else>
                      <span>(현재 파일: {{ value }})</span>
                    </div>
                  </template>
                  <!-- 그 외는 텍스트 입력 -->
                  <template v-else>
                    <input
                      type="text"
                      v-model="editRowData[key]"
                      :readonly="key === primaryKey"
                    />
                  </template>
                </td>
              </tr>
            </tbody>
          </table>
          <div>
            <button class="list-button" @click="backToList">List</button>
            <button class="save-button" @click="saveEdit">Save</button>
          </div>
        </div>
      </div>
    </div>
    <script>
      // Supabase 설정 (본인 Supabase URL, ANON KEY로 변경)
      const SUPABASE_URL = "https://pdwbghdbrzcaftdzjegw.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBkd2JnaGRicnpjYWZ0ZHpqZWd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMwNjI4NzYsImV4cCI6MjA1ODYzODg3Nn0.PS9lyc45XXnhVw52qq9TOQyYiWclxNxPwLGtSFX8VbI";
      const supabaseClient = supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      const app = Vue.createApp({
        data() {
          return {
            // 페이지 구분: 'login', 'signup', 'list'(admin 리스트), 'edit'(admin 수정)
            currentView: "login",
            // 로그인 데이터
            loginId: "",
            loginPw: "",
            // 회원가입 데이터
            signupEmail: "",
            signupPw: "",
            // 고정된 테이블 목록
            tables: [
              "sliders",
              "videothumbnails",
              "albums",
              "boards",
              "artists",
              "albumkinds",
              "songs",
              "playlists",
              "boards"
            ],
            selectedTable: null, // 선택된 테이블명
            tableData: [], // 리스트에 표시할 데이터
            currentPage: 1, // 현재 페이지 번호
            totalPages: 1, // 전체 페이지 수
            pageSize: 10, // 한 페이지당 표시 row 수
            supabase: supabaseClient,
            currentView: "list", // "list" 또는 "edit"
            editRowData: {}, // 수정 페이지 데이터
            isNew: false, // 새 row 추가 여부
            primaryKey: "idx", // 기본키 컬럼 (모든 테이블 idx라 가정)
            // 파일 업로드 및 미리보기 객체
            fileUploads: {},
            filePreviews: {},
            publicURL: "",
          };
        },
        computed: {
          // 테이블 헤더: 첫번째 row의 키 목록
          tableColumns() {
            if (this.tableData.length > 0) {
              return Object.keys(this.tableData[0]);
            }
            return [];
          },
        },
        methods: {
          /* ------ 인증 관련 메서드 ------ */
          async loginUser() {
            if (!this.loginId || !this.loginPw) {
              alert("아이디와 비밀번호를 모두 입력하세요.");
              return;
            }
            const { data, error } =
              await supabaseClient.auth.signInWithPassword({
                email: this.loginId,
                password: this.loginPw,
              });
            if (error) {
              alert("로그인 실패: " + error.message);
            } else {
              console.log(
                "로그인 성공. Access Token:",
                data.session.access_token
              );
              this.userEmail = data.user.email;
              this.currentView = "list";
              this.selectTable(this.tables[0]);
            }
          },
          goToSignup() {
            this.currentView = "signup";
            this.signupEmail = "";
            this.signupPw = "";
          },
          goToLogin() {
            this.currentView = "login";
            this.loginId = "";
            this.loginPw = "";
          },
          async signupUser() {
            if (!this.signupEmail || !this.signupPw) {
              alert("이메일과 비밀번호를 모두 입력하세요.");
              return;
            }
            const { error } = await supabaseClient.auth.signUp({
              email: this.signupEmail,
              password: this.signupPw,
            });
            if (error) {
              alert("회원가입 실패: " + error.message);
            } else {
              alert("회원가입 완료");
              this.currentView = "login";
            }
          },
          async logoutUser() {
            const { error } = await supabaseClient.auth.signOut();
            if (error) {
              console.error("로그아웃 에러:", error);
            } else {
              this.currentView = "login";
              this.loginId = "";
              this.loginPw = "";
              this.userEmail = "";
            }
          },

          // 테이블 선택 -> 데이터 조회
          async selectTable(table) {
            this.selectedTable = table;
            this.currentPage = 1;
            await this.fetchTableDataByTable();
            this.currentView = "list";
          },
          async fetchTableDataByTable() {
            // 현재 선택된 테이블명을 그대로 사용
            const fromIndex = (this.currentPage - 1) * this.pageSize;
            let query = this.supabase
              .from(this.selectedTable)
              .select("*", { count: "exact" })
              .order(this.primaryKey, { ascending: true })
              .range(fromIndex, fromIndex + this.pageSize - 1);
            const { data, count, error } = await query;
            if (error) {
              console.error(`${this.selectedTable} 데이터 조회 에러:`, error);
              this.tableData = [];
            } else {
              this.tableData = data;
              this.totalPages = Math.ceil(count / this.pageSize) || 1;
            }
          },
          // 리스트 페이지: Edit 버튼 클릭 -> 수정 페이지 전환
          goToEdit(row, isNew) {
            this.isNew = isNew;
            this.fileUploads = {};
            this.filePreviews = {};
            // 깊은 복사
            this.editRowData = JSON.parse(JSON.stringify(row));
            this.currentView = "edit";
          },
          // + 버튼 클릭 -> 새 row 추가 (기본 form 생성)
          async newRow() {
            if (!this.selectedTable) {
              alert("테이블을 먼저 선택하세요.");
              return;
            }
            let { data, error } = await this.supabase
              .from(this.selectedTable)
              .select(this.primaryKey, { count: "exact" })
              .order(this.primaryKey, { ascending: false })
              .limit(1);
            let newIdx = 1;
            if (error) {
              console.error("새 idx 계산 에러:", error);
            } else if (data && data.length > 0) {
              newIdx = data[0][this.primaryKey] + 1;
            }
            let newRow = {};
            if (this.tableData.length > 0) {
              Object.keys(this.tableData[0]).forEach((col) => {
                newRow[col] = col === this.primaryKey ? newIdx : "";
              });
            } else {
              newRow[this.primaryKey] = newIdx;
            }
            this.goToEdit(newRow, true);
          },
          // 파일 선택 이벤트 처리: fileUploads 및 filePreviews 업데이트
          handleFileChange(event, key) {
            const file = event.target.files[0];
            if (file) {
              this.fileUploads[key] = file;
              this.filePreviews[key] = URL.createObjectURL(file);
            }
          },
          // 수정/추가 페이지: Save 버튼 클릭 시 처리
          async saveEdit() {
            if (!this.selectedTable) return;
            for (let key in this.editRowData) {
              if (
                (key === "img" || key === "thumbnail") &&
                this.fileUploads[key]
              ) {
                const file = this.fileUploads[key];
                let currentURL = this.editRowData[key];
                this.editRowData[key] = "";
                let fileName = currentURL
                  ? currentURL.substring(currentURL.lastIndexOf("/") + 1)
                  : file.name;
                let filePath = fileName;
                // 기존 파일 삭제
                let { error: removeError } = await this.supabase.storage
                  .from(this.selectedTable)
                  .remove([filePath]);
                if (removeError && removeError.status !== 404) {
                  console.error(`${key} 기존 파일 삭제 에러:`, removeError);
                }
                // 새 파일 업로드 (동일한 파일명, 동일 경로)
                let { error: uploadError } = await this.supabase.storage
                  .from(this.selectedTable)
                  .upload(filePath, file, { upsert: true });
                if (uploadError) {
                  console.error(`${key} 새 파일 업로드 에러:`, uploadError);
                } else {
                  // Supabase의 getPublicUrl()을 사용하여 파일의 public URL 가져오기
                  const { error: urlError } = (publicURL = this.supabase.storage
                    .from(this.selectedTable)
                    .getPublicUrl(filePath).data.publicUrl);
                  console.log(publicURL);
                  if (urlError) {
                    console.error(`${key} URL 생성 에러:`, urlError);
                  } else {
                    this.editRowData[key] = publicURL;
                  }
                }
              }
            }

            // DB 업데이트: 신규 insert 또는 기존 row update
            if (this.isNew) {
              const { error } = await this.supabase
                .from(this.selectedTable)
                .insert([this.editRowData]);
              if (error) {
                console.error("새 row 삽입 에러:", error);
              } else {
                alert("추가되었습니다.");
              }
            } else {
              const { error } = await this.supabase
                .from(this.selectedTable)
                .update(this.editRowData)
                .eq(this.primaryKey, this.editRowData[this.primaryKey]);
              if (error) {
                console.error("row 수정 에러:", error);
              } else {
                alert("수정되었습니다.");
              }
            }
            this.currentView = "list";
            this.fetchTableDataByTable();
          },
          // List 버튼 클릭 -> 리스트 페이지로 복귀
          backToList() {
            this.currentView = "list";
            this.editRowData = {};
            this.fileUploads = {};
            this.filePreviews = {};
          },
          // Delete 버튼: 개별 row 삭제
          async deleteRow(row) {
            if (!this.selectedTable) return;
            if (confirm("해당 row를 삭제하시겠습니까?")) {
              const { error } = await this.supabase
                .from(this.selectedTable)
                .delete()
                .eq(this.primaryKey, row[this.primaryKey]);
              if (error) {
                console.error("row 삭제 에러:", error);
              } else {
                this.fetchTableDataByTable();
              }
            }
          },
          // 전체삭제 버튼: 현재 테이블의 모든 행 삭제
          async deleteAllRows() {
            if (!this.selectedTable) return;
            if (confirm("정말 모든 행을 삭제하시겠습니까?")) {
              // 테이블에 img 컬럼이 존재하면 해당 컬럼의 모든 파일 삭제
              if (this.tableColumns && this.tableColumns.includes("img")) {
                // 전체 행의 img 컬럼 값을 조회 (전체 데이터 조회)
                let { data: allData, error } = await this.supabase
                  .from(this.selectedTable)
                  .select("img");
                if (error) {
                  console.error("전체 삭제 이미지 데이터 조회 에러:", error);
                } else {
                  let filePaths = [];
                  allData.forEach((row) => {
                    if (row.img) {
                      let fileName = row.img.substring(
                        row.img.lastIndexOf("/") + 1
                      );
                      // 파일 경로: "테이블명/파일명"
                      filePaths.push(this.selectedTable + "/" + fileName);
                    }
                  });
                  if (filePaths.length > 0) {
                    let { error: removeError } = await this.supabase.storage
                      .from("sources")
                      .remove(filePaths);
                    if (removeError && removeError.status !== 404) {
                      console.error("전체 삭제 파일 제거 에러:", removeError);
                    }
                  }
                }
              }
              // DB의 모든 행 삭제
              let { error: deleteError } = await this.supabase
                .from(this.selectedTable)
                .delete();
              if (deleteError) {
                console.error("전체 삭제 row 제거 에러:", deleteError);
              } else {
                alert("전체 삭제되었습니다.");
                this.tableData = [];
              }
            }
          },
          // 페이지네이션: 이전 페이지
          async prevPage() {
            if (this.currentPage > 1) {
              this.currentPage--;
              await this.fetchTableDataByTable();
            }
          },
          // 페이지네이션: 다음 페이지
          async nextPage() {
            if (this.currentPage < this.totalPages) {
              this.currentPage++;
              await this.fetchTableDataByTable();
            }
          },

          // 로그인 상태 유지: 앱 시작 시 세션 확인 후 Admin 화면으로 이동
          async checkSession() {
            const {
              data: { session },
            } = await supabaseClient.auth.getSession();
            if (session) {
              this.userEmail = session.user.email;
              this.currentView = "list";
            }
          },
        },
        mounted() {
          this.checkSession();
        },
      });

      app.mount("#app");
    </script>
  </body>
</html>
