<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Admin 페이지 with 로그인/회원가입 & 파일 미리보기</title>
  <script src="https://unpkg.com/vue@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    /* 공통 스타일 */
    body { margin: 0; font-family: Arial, sans-serif; background: #f5f5f5; }
    h2 { margin-bottom: 20px; }

    /* 로그인/회원가입 페이지 스타일 */
    .auth-container {
      max-width: 400px;
      margin: 100px auto;
      background: #fff;
      padding: 30px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: center;
    }
    .auth-container input {
      width: calc(100% - 20px);
      padding: 8px 10px;
      margin: 10px 0;
      font-size: 16px;
    }
    .auth-container button {
      padding: 10px 15px;
      font-size: 16px;
      margin: 10px 5px;
      cursor: pointer;
    }
    .dup-check-btn {
      margin-left: 5px;
      padding: 8px 12px;
      font-size: 14px;
    }

    /* Admin 페이지 스타일 (기존) */
    .sidebar { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 200px; 
      height: 100vh; 
      background-color: #000; 
      color: #fff; 
      overflow-y: auto; 
      padding: 10px; 
      z-index: 100; 
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .table-list { flex-grow: 1; }
    .table-button { 
      display: block; 
      width: 100%; 
      padding: 8px; 
      margin-bottom: 10px; 
      background-color: #333; 
      border: none; 
      color: #fff; 
      text-align: left; 
      cursor: pointer; 
    }
    .table-button:hover { background-color: #555; }
    .logout-button { 
      padding: 10px; 
      background-color: #dc3545; 
      border: none; 
      color: #fff; 
      width: 100%; 
      cursor: pointer; 
      margin-top: 10px;
    }
    .content { 
      margin-left: 220px; 
      padding: 20px; 
      position: relative; 
      background: #fff; 
      min-height: 100vh; 
    }
    .plus-button { 
      position: absolute; 
      top: 20px; 
      right: 20px; 
      padding: 10px 15px; 
      background-color: green; 
      color: #fff; 
      border: none; 
      cursor: pointer; 
      font-size: 18px; 
    }
    table { width: 100%; border-collapse: collapse; }
    thead th { 
      background: #f0f0f0; 
      padding: 10px; 
      border: 1px solid #ccc; 
    }
    tbody td { 
      padding: 8px; 
      border: 1px solid #ccc; 
      text-align: left; 
    }
    .action-button { 
      margin: 0 3px; 
      padding: 5px 10px; 
      border: none; 
      cursor: pointer; 
    }
    .edit-button { background-color: #007bff; color: #fff; }
    .delete-button { background-color: #dc3545; color: #fff; }
    .pagination { margin-top: 15px; text-align: center; }
    .pagination button { 
      margin: 0 10px; 
      padding: 5px 10px; 
      cursor: pointer; 
    }
    .edit-form { max-width: 600px; margin: auto; }
    .edit-form table { width: 100%; }
    .edit-form td { 
      padding: 5px; 
      vertical-align: top; 
    }
    .edit-form input[type="text"],
    .edit-form input[type="file"],
    .edit-form input[type="password"] { 
      width: 100%; 
      padding: 5px; 
      box-sizing: border-box; 
      font-size: 14px;
    }
    .file-input-group {
      display: flex;
      align-items: center;
    }
    .img-preview {
      width: 100px;
      height: auto;
      margin-left: 10px;
      border: 1px solid #ccc;
      padding: 2px;
      background: #fff;
    }
    .save-button, .list-button {
      margin-top: 15px; 
      padding: 10px 15px; 
      border: none; 
      cursor: pointer; 
      font-size: 16px; 
      display: inline-block; 
      width: 48%;
    }
    .save-button { background-color: blue; color: #fff; }
    .list-button { 
      background-color: gray; 
      color: #fff; 
      margin-right: 4%; 
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- 로그인 페이지 -->
    <div v-if="currentView === 'login'" class="auth-container">
      <h2>로그인</h2>
      <div>
        <input type="text" v-model="loginId" placeholder="아이디(이메일)" />
      </div>
      <div>
        <input type="password" v-model="loginPw" placeholder="비밀번호" />
      </div>
      <div>
        <button @click="loginUser">Login</button>
        <button @click="goToSignup">회원가입</button>
      </div>
    </div>

    <!-- 회원가입 페이지 -->
    <div v-if="currentView === 'signup'" class="auth-container">
      <h2>회원가입</h2>
      <div style="text-align: left;">
        <label>이메일</label>
        <div style="display: flex; align-items: center;">
          <input type="text" v-model="signupEmail" placeholder="이메일" />
        </div>
      </div>
      <div>
        <input type="password" v-model="signupPw" placeholder="비밀번호" />
      </div>
      <div>
        <button @click="signupUser">회원가입</button>
        <button @click="goToLogin">취소</button>
      </div>
    </div>

    <!-- Admin 페이지: 리스트/수정 페이지 (로그인 성공 후) -->
    <div v-if="currentView === 'list' || currentView === 'edit'">
      <!-- 좌측 사이드바 -->
      <div class="sidebar">
        <div class="table-list">
          <span style="display:block; margin-bottom: 15px;">LOGIN<br>{{ userEmail }}</span>
          <h3>테이블 목록</h3>
          <div v-for="table in tables" :key="table">
            <button class="table-button" @click="selectTable(table)">{{ table }}</button>
          </div>
        </div>
        <button class="logout-button" @click="logoutUser">LogOut</button>
      </div>
      
      <!-- 우측 리스트/수정 콘텐츠 -->
      <div class="content">
        <!-- 리스트 페이지 -->
        <div v-if="currentView === 'list'">
          <!-- + 버튼: 새 row 추가 -->
          <button class="plus-button" @click="newRow">+</button>
          <div v-if="selectedTable">
            <h2>{{ selectedTable }} - 데이터</h2>
            <table v-if="tableData.length > 0">
              <thead>
                <tr>
                  <!-- 헤더: 첫 row의 키를 사용 -->
                  <th v-for="col in tableColumns" :key="col">{{ col }}</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(row, index) in tableData" :key="row[primaryKey] || index">
                  <td v-for="col in tableColumns" :key="col">{{ row[col] }}</td>
                  <td>
                    <button class="action-button edit-button" @click="goToEdit(row, false)">Edit</button>
                    <button class="action-button delete-button" @click="deleteRow(row)">Delete</button>
                  </td>
                </tr>
              </tbody>
            </table>
            <div v-else>
              <p>데이터가 없습니다.</p>
            </div>
            <!-- 페이지네이션 -->
            <div class="pagination">
              <button @click="prevPage" :disabled="currentPage === 1">Prev</button>
              <span>{{ currentPage }} / {{ totalPages }}</span>
              <button @click="nextPage" :disabled="currentPage === totalPages">Next</button>
            </div>
          </div>
          <div v-else>
            <h2>테이블을 선택하세요.</h2>
          </div>
        </div>
        <!-- 수정/추가 페이지 -->
        <div v-if="currentView === 'edit'">
          <h2>{{ isNew ? '새로운 row 추가' : '데이터 수정' }} - {{ selectedTable }}</h2>
          <div class="edit-form">
            <table>
              <tbody>
                <tr v-for="(value, key) in editRowData" :key="key">
                  <td style="width:30%;"><strong>{{ key }}</strong></td>
                  <td>
                    <!-- 파일 업로드 처리: songs 테이블 제외하고 key가 img 또는 thumbnail 인 경우 -->
                    <template v-if="selectedTable !== 'songs' && (key === 'img' || key === 'thumbnail')">
                      <div class="file-input-group">
                        <input type="file" @change="handleFileChange($event, key)" accept="image/*" />
                        <!-- 기존 파일명은 텍스트로 보여주되, 파일 변경 여부는 fileUploads[key] 로 판단 -->
                        <span v-if="!filePreviews[key]" style="margin-left: 10px;">(현재 파일: {{ editRowData[key] }})</span>
                        <img v-if="filePreviews[key]" :src="filePreviews[key]" alt="Preview" class="img-preview" />
                      </div>
                    </template>
                    <!-- 나머지 경우, 텍스트 입력 -->
                    <template v-else>
                      <input type="text" v-model="editRowData[key]" :readonly="key === primaryKey" />
                    </template>
                  </td>
                </tr>
              </tbody>
            </table>
            <div>
              <button class="list-button" @click="backToList">List</button>
              <button class="save-button" @click="saveEdit">Save</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Supabase 설정 (본인 Supabase URL 및 ANON KEY로 변경)
    const SUPABASE_URL = 'https://pdwbghdbrzcaftdzjegw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBkd2JnaGRicnpjYWZ0ZHpqZWd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMwNjI4NzYsImV4cCI6MjA1ODYzODg3Nn0.PS9lyc45XXnhVw52qq9TOQyYiWclxNxPwLGtSFX8VbI';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    const app = Vue.createApp({
      data() {
        return {
          // 페이지 구분: 'login', 'signup', 'list'(admin 리스트), 'edit'(admin 수정)
          currentView: 'login',
          // 로그인 데이터
          loginId: '',
          loginPw: '',
          // 회원가입 데이터
          signupEmail: '',
          signupPw: '',
          // Admin 페이지 관련 데이터
          tables: [
            "sliders", 
            "videoThumbnails", 
            "albums", 
            "boards", 
            "artists", 
            "albumKinds", 
            "songs", 
            "playlists"
          ],
          selectedTable: null,
          tableData: [],
          currentPage: 1,
          totalPages: 1,
          pageSize: 10,
          editRowData: {},
          isNew: false,
          primaryKey: 'idx',
          userEmail: '',
          // 파일 첨부 및 미리보기를 위한 객체
          fileUploads: {},
          filePreviews: {}
        };
      },
      computed: {
        // 테이블의 첫번째 row로 헤더 생성
        tableColumns() {
          if (this.tableData.length > 0) {
            return Object.keys(this.tableData[0]);
          }
          return [];
        }
      },
      methods: {
        /* ------ 인증 관련 메서드 ------ */
        async loginUser() {
          if (!this.loginId || !this.loginPw) {
            alert("아이디와 비밀번호를 모두 입력하세요.");
            return;
          }
          const { data, error } = await supabaseClient.auth.signInWithPassword({ 
            email: this.loginId, 
            password: this.loginPw 
          });
          if (error) {
            alert("로그인 실패: " + error.message);
          } else {
            console.log('로그인 성공. Access Token:', data.session.access_token);
            this.userEmail = data.user.email;
            this.currentView = 'list';
          }
        },
        goToSignup() {
          this.currentView = 'signup';
          this.signupEmail = '';
          this.signupPw = '';
        },
        goToLogin() {
          this.currentView = 'login';
          this.loginId = '';
          this.loginPw = '';
        },
        async signupUser() {
          if (!this.signupEmail || !this.signupPw) {
            alert("이메일과 비밀번호를 모두 입력하세요.");
            return;
          }
          const { error } = await supabaseClient.auth.signUp({
            email: this.signupEmail,
            password: this.signupPw
          });
          if (error) {
            alert("회원가입 실패: " + error.message);
          } else {
            alert("회원가입 완료");
            this.currentView = 'login';
          }
        },
        async logoutUser() {
          const { error } = await supabaseClient.auth.signOut();
          if (error) {
            console.error("로그아웃 에러:", error);
          } else {
            this.currentView = 'login';
            this.loginId = '';
            this.loginPw = '';
            this.userEmail = '';
          }
        },
        
        /* ------ 파일 입력 및 미리보기 처리 ------ */
        handleFileChange(event, key) {
          const file = event.target.files[0];
          if (file) {
            // 파일 객체 저장
            this.fileUploads[key] = file;
            // 미리보기 URL 생성 (브라우저 메모리 내)
            this.filePreviews[key] = URL.createObjectURL(file);
          }
        },
        /* ------ Admin 페이지 기능 ------ */
        async selectTable(table) {
          this.selectedTable = table;
          this.currentPage = 1;
          await this.fetchTableDataByTable();
          this.currentView = 'list';
        },
        async fetchTableDataByTable() {
          if (!this.selectedTable) return;
          switch (this.selectedTable) {
            case 'sliders':
              await this.fetchDataCommon('sliders');
              break;
            case 'videoThumbnails':
              await this.fetchDataCommon('videothumbnails');
              break;
            case 'albums':
              await this.fetchDataCommon('albums');
              break;
            case 'boards':
              await this.fetchDataCommon('boards');
              break;
            case 'artists':
              await this.fetchDataCommon('artists');
              break;
            case 'albumKinds':
              await this.fetchDataCommon('albumkinds');
              break;
            case 'songs':
              await this.fetchDataCommon('songs');
              break;
            case 'playlists':
              await this.fetchDataCommon('playlists');
              break;
            default:
              console.warn("알 수 없는 테이블:", this.selectedTable);
          }
        },
        async fetchDataCommon(tableName) {
          const fromIndex = (this.currentPage - 1) * this.pageSize;
          let query = supabaseClient
            .from(tableName)
            .select('*', { count: 'exact' })
            .order(this.primaryKey, { ascending: true })
            .range(fromIndex, fromIndex + this.pageSize - 1);
          const { data, count, error } = await query;
          if (error) {
            console.error(`${tableName} 데이터 조회 에러:`, error);
            this.tableData = [];
          } else {
            this.tableData = data;
            this.totalPages = Math.ceil(count / this.pageSize) || 1;
          }
        },
        goToEdit(row, isNew) {
          this.isNew = isNew;
          // 기존 파일 관련 상태 초기화
          this.fileUploads = {};
          this.filePreviews = {};
          // 깊은 복사로 데이터 복제
          this.editRowData = JSON.parse(JSON.stringify(row));
          this.currentView = 'edit';
        },
        async newRow() {
          if (!this.selectedTable) {
            alert("테이블을 먼저 선택하세요.");
            return;
          }
          let { data, error } = await supabaseClient
            .from(this.selectedTable)
            .select(this.primaryKey, { count: 'exact' })
            .order(this.primaryKey, { ascending: false })
            .limit(1);
          let newIdx = 1;
          if (error) {
            console.error("새 idx 계산 에러:", error);
          } else if (data && data.length > 0) {
            newIdx = data[0][this.primaryKey] + 1;
          }
          let newRow = {};
          if (this.tableData.length > 0) {
            Object.keys(this.tableData[0]).forEach(col => {
              newRow[col] = (col === this.primaryKey) ? newIdx : "";
            });
          } else {
            newRow[this.primaryKey] = newIdx;
          }
          this.goToEdit(newRow, true);
        },
        async saveEdit() {
          // 만약 파일 첨부가 있다면, songs 테이블 외의 img 또는 thumbnail 필드 처리
          if (this.selectedTable !== 'songs') {
            for (let key in this.fileUploads) {
              if (this.fileUploads[key]) {
                const file = this.fileUploads[key];
                // 기존 파일명을 그대로 유지: 만약 기존 데이터에 파일명이 있다면 그대로 사용하고, 없다면 file.name 사용
                let fileName = this.editRowData[key] || file.name;
                // Supabase Storage를 사용하는 예제 (버킷 이름은 'images'로 가정)
                // 기존 파일 삭제 후 새 파일 업로드 (upsert 옵션 사용)
                let { error: removeError } = await supabaseClient.storage.from('images').remove([fileName]);
                if (removeError) {
                  console.error(`기존 ${key} 파일 삭제 에러:`, removeError);
                }
                let { error: uploadError } = await supabaseClient.storage.from('images').upload(fileName, file, { upsert: true });
                if (uploadError) {
                  console.error(`새 ${key} 파일 업로드 에러:`, uploadError);
                } else {
                  console.log(`${key} 파일 업로드 성공: ${fileName}`);
                  // DB에 저장할 값은 파일명 그대로 유지
                  this.editRowData[key] = fileName;
                }
              }
            }
          }
          // 데이터 insert/update 처리 (기존 코드와 동일)
          if (!this.selectedTable) return;
          if (this.isNew) {
            const { error } = await supabaseClient
              .from(this.selectedTable)
              .insert([this.editRowData]);
            if (error) {
              console.error('새 row 삽입 에러:', error);
            } else {
              alert("추가되었습니다.");
            }
          } else {
            const { error } = await supabaseClient
              .from(this.selectedTable)
              .update(this.editRowData)
              .eq(this.primaryKey, this.editRowData[this.primaryKey]);
            if (error) {
              console.error('row 수정 에러:', error);
            } else {
              alert("수정되었습니다.");
            }
          }
          this.currentView = 'list';
          this.fetchTableDataByTable();
        },
        backToList() {
          this.currentView = 'list';
          this.editRowData = {};
          // 파일 첨부 관련 상태 초기화
          this.fileUploads = {};
          this.filePreviews = {};
        },
        async deleteRow(row) {
          if (!this.selectedTable) return;
          if (confirm("해당 row를 삭제하시겠습니까?")) {
            const { error } = await supabaseClient
              .from(this.selectedTable)
              .delete()
              .eq(this.primaryKey, row[this.primaryKey]);
            if (error) {
              console.error('row 삭제 에러:', error);
            } else {
              this.fetchTableDataByTable();
            }
          }
        },
        async prevPage() {
          if (this.currentPage > 1) {
            this.currentPage--;
            await this.fetchTableDataByTable();
          }
        },
        async nextPage() {
          if (this.currentPage < this.totalPages) {
            this.currentPage++;
            await this.fetchTableDataByTable();
          }
        },
        // 로그인 상태 유지: 앱 시작 시 세션 확인 후 Admin 화면으로 이동
        async checkSession() {
          const { data: { session } } = await supabaseClient.auth.getSession();
          if (session) {
            this.userEmail = session.user.email;
            this.currentView = 'list';
          }
        }
      },
      mounted() {
        this.checkSession();
      }
    });
    
    app.mount('#app');
  </script>
</body>
</html>
