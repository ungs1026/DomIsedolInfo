<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Admin 페이지</title>
  <script src="https://unpkg.com/vue@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    /* 기본 스타일 초기화 및 폰트 설정 */
    body { margin: 0; font-family: Arial, sans-serif; }
    .sidebar { position: fixed; top: 0; left: 0; width: 200px; height: 100vh; background-color: #000; color: #fff; overflow-y: auto; padding: 10px; z-index: 100; }
    .table-button { display: block; width: 100%; padding: 8px; margin-bottom: 10px; background-color: #333; border: none; color: #fff; text-align: left; cursor: pointer; }
    .table-button:hover { background-color: #555; }
    .content { margin-left: 220px; padding: 20px; position: relative; }
    .plus-button { position: absolute; top: 20px; right: 20px; padding: 10px 15px; background-color: green; color: #fff; border: none; cursor: pointer; font-size: 18px; }
    table { width: 100%; border-collapse: collapse; }
    thead th { background: #f0f0f0; padding: 10px; border: 1px solid #ccc; }
    tbody td { padding: 8px; border: 1px solid #ccc; text-align: left; }
    .action-button { margin: 0 3px; padding: 5px 10px; border: none; cursor: pointer; }
    .edit-button { background-color: #007bff; color: #fff; }
    .delete-button { background-color: #dc3545; color: #fff; }
    .pagination { margin-top: 15px; text-align: center; }
    .pagination button { margin: 0 10px; padding: 5px 10px; cursor: pointer; }
    .edit-form { max-width: 600px; margin: auto; }
    .edit-form table { width: 100%; }
    .edit-form td { padding: 5px; vertical-align: top; }
    .edit-form input { width: 100%; padding: 5px; box-sizing: border-box; }
    .save-button, .list-button { margin-top: 15px; padding: 10px 15px; border: none; cursor: pointer; font-size: 16px; display: inline-block; width: 48%; }
    .save-button { background-color: blue; color: #fff; }
    .list-button { background-color: gray; color: #fff; margin-right: 4%; }
  </style>
</head>
<body>
  <div id="app">
    <!-- SPA 내 페이지 전환: list view vs. edit view -->
    <div v-if="currentView === 'list'">
      <!-- 좌측 사이드바 -->
      <div class="sidebar">
        <h3>테이블 목록</h3>
        <div v-for="table in tables" :key="table">
          <button class="table-button" @click="selectTable(table)">{{ table }}</button>
        </div>
      </div>
      
      <!-- 우측 리스트 콘텐츠 -->
      <div class="content">
        <!-- + 버튼: 새 row 추가 -->
        <button class="plus-button" @click="newRow">+</button>
        <div v-if="selectedTable">
          <h2>{{ selectedTable }} - 데이터</h2>
          <table v-if="tableData.length > 0">
            <thead>
              <tr>
                <!-- 헤더: 첫 row의 키를 사용 -->
                <th v-for="col in tableColumns" :key="col">{{ col }}</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="(row, index) in tableData" :key="row[idx] || index">
                <td v-for="col in tableColumns" :key="col">{{ row[col] }}</td>
                <td>
                  <button class="action-button edit-button" @click="goToEdit(row, false)">Edit</button>
                  <button class="action-button delete-button" @click="deleteRow(row)">Delete</button>
                </td>
              </tr>
            </tbody>
          </table>
          <div v-else>
            <p>데이터가 없습니다.</p>
          </div>
          <!-- 페이지네이션 -->
          <div class="pagination">
            <button @click="prevPage" :disabled="currentPage === 1">Prev</button>
            <span>{{ currentPage }} / {{ totalPages }}</span>
            <button @click="nextPage" :disabled="currentPage === totalPages">Next</button>
          </div>
        </div>
        <div v-else>
          <h2>테이블을 선택하세요.</h2>
        </div>
      </div>
    </div>
    
    <!-- 수정/추가 페이지 -->
    <div v-if="currentView === 'edit'" class="content">
      <h2>{{ isNew ? '새로운 row 추가' : '데이터 수정' }} - {{ selectedTable }}</h2>
      <div class="edit-form">
        <table>
          <tbody>
            <tr v-for="(value, key) in editRowData" :key="key">
              <td><strong>{{ key }}</strong></td>
              <td>
                <input type="text" v-model="editRowData[key]" :readonly="key === primaryKey" />
              </td>
            </tr>
          </tbody>
        </table>
        <div>
          <button class="list-button" @click="backToList">List</button>
          <button class="save-button" @click="saveEdit">Save</button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Supabase 설정 (본인 Supabase URL, ANON KEY로 변경)
    const SUPABASE_URL = 'https://pdwbghdbrzcaftdzjegw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBkd2JnaGRicnpjYWZ0ZHpqZWd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMwNjI4NzYsImV4cCI6MjA1ODYzODg3Nn0.PS9lyc45XXnhVw52qq9TOQyYiWclxNxPwLGtSFX8VbI';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    const app = Vue.createApp({
      data() {
        return {
          // 고정된 테이블(버튼) 목록
          tables: [
            "sliders", 
            "videoThumbnails", 
            "albums", 
            "boards", 
            "artists", 
            "albumKinds", 
            "songs", 
            "playlists"
          ],
          selectedTable: null,    // 현재 선택된 테이블 이름
          tableData: [],          // 리스트 페이지에 표시할 데이터 배열
          currentPage: 1,         // 현재 페이지 번호
          totalPages: 1,          // 전체 페이지 수 (페이지 사이즈 기준)
          pageSize: 10,           // 한 페이지당 출력 row 수
          supabase: supabaseClient,
          currentView: 'list',    // "list" 또는 "edit"로 페이지 전환
          editRowData: {},        // 수정 페이지에서 사용하는 데이터 객체
          isNew: false,           // 수정 여부 플래그 (새로운 row이면 true)
          primaryKey: 'idx'       // 각 테이블의 기본키 컬럼 (모든 테이블은 idx라 가정)
        };
      },
      computed: {
        // 리스트 페이지에서 테이블의 첫 번째 row를 기준으로 헤더 생성
        tableColumns() {
          if (this.tableData.length > 0) {
            return Object.keys(this.tableData[0]);
          }
          return [];
        }
      },
      methods: {
        // 리스트 페이지: 테이블 선택 시 해당 데이터 조회
        async selectTable(table) {
          this.selectedTable = table;
          this.currentPage = 1;
          await this.fetchTableDataByTable();
          this.currentView = 'list';
        },
        // 선택한 테이블 이름에 따라 전용 데이터 조회 함수 호출
        async fetchTableDataByTable() {
          switch (this.selectedTable) {
            case 'sliders':
              await this.fetchDataCommon('sliders');
              break;
            case 'videoThumbnails':
              await this.fetchDataCommon('videothumbnails');
              break;
            case 'albums':
              await this.fetchDataCommon('albums');
              break;
            case 'boards':
              await this.fetchDataCommon('boards');
              break;
            case 'artists':
              await this.fetchDataCommon('artists');
              break;
            case 'albumKinds':
              await this.fetchDataCommon('albumkinds');
              break;
            case 'songs':
              await this.fetchDataCommon('songs');
              break;
            case 'playlists':
              await this.fetchDataCommon('playlists');
              break;
            default:
              console.warn("알 수 없는 테이블:", this.selectedTable);
          }
        },
        // 공통 데이터 조회 함수 (테이블명, 기본키 컬럼을 기준으로 정렬 및 페이징)
        async fetchDataCommon(tableName) {
          const fromIndex = (this.currentPage - 1) * this.pageSize;
          let query = this.supabase
            .from(tableName)
            .select('*', { count: 'exact' })
            .order(this.primaryKey, { ascending: true })
            .range(fromIndex, fromIndex + this.pageSize - 1);
          const { data, count, error } = await query;
          if (error) {
            console.error(`${tableName} 데이터 조회 에러:`, error);
            this.tableData = [];
          } else {
            this.tableData = data;
            this.totalPages = Math.ceil(count / this.pageSize) || 1;
          }
        },
        // 리스트 페이지: Edit 버튼 -> 수정 페이지로 전환 (기존 row)
        goToEdit(row, isNew) {
          this.isNew = isNew;
          // 깊은 복사하여 editRowData에 저장
          this.editRowData = JSON.parse(JSON.stringify(row));
          this.currentView = 'edit';
        },
        // + 버튼 클릭: 새 row 추가를 위한 수정 페이지 전환
        async newRow() {
          if (!this.selectedTable) {
            alert("테이블을 먼저 선택하세요.");
            return;
          }
          // 새 row의 idx = 현재 테이블의 최대 idx + 1
          let { data, error } = await this.supabase
            .from(this.selectedTable)
            .select(this.primaryKey, { count: 'exact' })
            .order(this.primaryKey, { ascending: false })
            .limit(1);
          let newIdx = 1;
          if (error) {
            console.error("새 idx 계산 에러:", error);
          } else if (data && data.length > 0) {
            newIdx = data[0][this.primaryKey] + 1;
          }
          // 새 row의 기본 폼 생성: 기존 데이터가 있다면 컬럼 구조 사용, 아니면 기본키만 존재
          let newRow = {};
          if (this.tableData.length > 0) {
            Object.keys(this.tableData[0]).forEach(col => {
              newRow[col] = (col === this.primaryKey) ? newIdx : "";
            });
          } else {
            newRow[this.primaryKey] = newIdx;
          }
          // 수정 페이지로 전환 (isNew=true)
          this.goToEdit(newRow, true);
        },
        // 수정 페이지: Save 버튼 클릭 -> update (수정) 또는 insert (새 row)
        async saveEdit() {
          if (!this.selectedTable) return;
          if (this.isNew) {
            // insert 처리
            const { error } = await this.supabase
              .from(this.selectedTable)
              .insert([this.editRowData]);
            if (error) {
              console.error('새 row 삽입 에러:', error);
            } else {
              alert("추가되었습니다.");
            }
          } else {
            // update 처리 (기본키 기준)
            const { error } = await this.supabase
              .from(this.selectedTable)
              .update(this.editRowData)
              .eq(this.primaryKey, this.editRowData[this.primaryKey]);
            if (error) {
              console.error('row 수정 에러:', error);
            } else {
              alert("수정되었습니다.");
            }
          }
          this.currentView = 'list';
          this.fetchTableDataByTable();
        },
        // 수정/추가 페이지: List 버튼 클릭 -> 아무 변경없이 리스트 페이지로 복귀
        backToList() {
          this.currentView = 'list';
          // 입력값 초기화
          this.editRowData = {};
        },
        // 리스트 페이지: Delete 버튼 -> 해당 row 삭제
        async deleteRow(row) {
          if (!this.selectedTable) return;
          if (confirm("해당 row를 삭제하시겠습니까?")) {
            const { error } = await this.supabase
              .from(this.selectedTable)
              .delete()
              .eq(this.primaryKey, row[this.primaryKey]);
            if (error) {
              console.error('row 삭제 에러:', error);
            } else {
              this.fetchTableDataByTable();
            }
          }
        },
        // 페이지네이션: 이전 페이지
        async prevPage() {
          if (this.currentPage > 1) {
            this.currentPage--;
            await this.fetchTableDataByTable();
          }
        },
        // 페이지네이션: 다음 페이지
        async nextPage() {
          if (this.currentPage < this.totalPages) {
            this.currentPage++;
            await this.fetchTableDataByTable();
          }
        }
      },
      mounted() {
        // 앱 시작 시 리스트 모드; 필요시 첫 테이블 자동 선택 가능
        // this.selectTable(this.tables[0]);
      }
    });
    
    app.mount('#app');
  </script>
</body>
</html>
