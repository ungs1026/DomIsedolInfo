<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Watch Party</title>
  <style>
    :root { --main-color: #9b59b6; }
    body, html { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; }
    #app { display: flex; flex-direction: column; height: 100%; }
    header { background: var(--main-color); color: #fff; padding: 0.5rem 1rem; display: flex; justify-content: space-between; align-items: center; }
    header span { font-weight: bold; }
    main { flex: 1; display: flex; position: relative; }
    #room-list { padding: 1rem; width: 100%; overflow-y: auto; background-color: black; color: white; font-weight: bold;}
    #room-list h2 {color: white;}
    #room-list ul { list-style: none; padding: 0;}
    #room-list li { position: relative; padding: 0.75rem; margin-bottom: 20px; color: white; box-shadow: 0 0 5px 2px #9b59b6; cursor: pointer; border-radius: 4px;
      background-size: 0% 100%; /* 초기 배경 크기를 0%로 설정 */
      background-image: linear-gradient(90deg, #9b59b6 8%, #3f174f 80%, #000000 100%); /* 배경 이미지 설정 */
      background-repeat: no-repeat; /* 배경 이미지 반복 방지 */
      transition: background-size 0.5s ease-in-out; /* 배경 크기 변화에 transition 적용 */
    }
    #room-list li:hover {
      background-size: 100% 100%; /* hover 시 배경 크기를 100%로 변경 */
    }
    #party-view { display: none; flex: 1; }
    #party-container { display: flex; width: 100%; height: 100%; }
    #video-area { flex: 4; position: relative; background: #000; display: flex; flex-direction: column; }
    #video-area iframe { width: 100%; height: 100%; }
    #player { flex: 12; }
    #controls { flex: 1; background-color: var(--main-color); bottom: 10px; left: 10px; right: 10px; display: flex; justify-content: space-between; align-items: center; gap: 1rem; padding-inline: 20px; }
    #controls input[type=range] { width: 16vw; padding: 0; margin: 0;}
    #sync-btn {margin: 0; padding: 2px 2vw; border:3px solid white; background: transparent; border-radius: 2px; color: white; font-weight: bold;}
    #chat-area { flex: 1; border-left: 2px solid #ddd; display: flex; flex-direction: column; }
    #chat-log { flex: 12; padding: 0.75rem; overflow-y: auto; background: black; color: white; overflow-y: auto; }
    #chat-log p { margin: 0.25rem 0; }
    #chat-input { flex: 1; display: flex; border-top: 1px solid #ccc; background-color: black;}
    #chat-input input { flex: 1; width: 100%; background-color: black; color: white;}
    #chat-input button { padding: 0.5rem 1rem; background: var(--main-color); color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    #back-button { background: #fff; color: var(--main-color); border: 2px solid var(--main-color); padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div>닉네임: <span id="nickname"></span></div>
      <button id="back-button" onclick="showRoomList()">List</button>
    </header>
    <main>
      <div id="room-list">
        <h2>Watch Party 방 목록</h2>
        <ul id="rooms"></ul>
      </div>
      <div id="party-view">
        <div id="party-container">
          <div id="video-area">
            <div id="player"></div>
            <div id="controls">
              <input type="range" id="volume-slider" min="0" max="1" step="0.01" title="볼륨 조절" />
              <button id="sync-btn">Sync</button>
            </div>
          </div>
          <div id="chat-area">
            <div id="chat-log"></div>
            <div id="chat-input">
              <input type="text" id="chat-text" placeholder="채팅을 입력하세요..." />
              <button id="chat-send">send</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const SUPABASE_URL = "https://pdwbghdbrzcaftdzjegw.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBkd2JnaGRicnpjYWZ0ZHpqZWd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMwNjI4NzYsImV4cCI6MjA1ODYzODg3Nn0.PS9lyc45XXnhVw52qq9TOQyYiWclxNxPwLGtSFX8VbI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let player, roomId, syncInterval, commentSub;
    let playerReadyVideoId = null;
    const nicknameEl = document.getElementById('nickname');
    const roomsUl = document.getElementById('rooms');
    const roomListDiv = document.getElementById('room-list');
    const partyViewDiv = document.getElementById('party-view');
    const chatLog = document.getElementById('chat-log');
    const chatText = document.getElementById('chat-text');
    const chatSend = document.getElementById('chat-send');
    const volumeSlider = document.getElementById('volume-slider');
    const syncBtn = document.getElementById('sync-btn');
    const backButton = document.getElementById('back-button');

    function formatTime(seconds) {
      seconds = Math.floor(seconds);
      const hrs = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      return hrs > 0 ? `${hrs}:${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}` : `${mins}:${String(secs).padStart(2,'0')}`;
    }

    function askNickname() {
      let nick = sessionStorage.getItem('user_nickname');
      if (!nick) {
        nick = prompt('닉네임을 입력하세요:') || '익명';
        sessionStorage.setItem('user_nickname', nick);
      }
      nicknameEl.textContent = sessionStorage.getItem('user_nickname');
    }

    function onYouTubeIframeAPIReady() {
      if (playerReadyVideoId) createPlayer();
    }

    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.PLAYING) loadChat();
    }

    function initPlayer(videoId) {
      playerReadyVideoId = videoId;
      if (window.YT && YT.Player) createPlayer();
    }

    function createPlayer() {
      if (player) player.destroy();
      player = new YT.Player('player', {
        videoId: playerReadyVideoId,
        playerVars: { controls: 0, modestbranding: 1, autoplay: 0 },
        events: { onStateChange: onPlayerStateChange }
      });
    }

    async function loadRooms() {
      const { data } = await supabase
        .from('watchparty_room')
        .select('*')
        .eq('public', true)
        .order('idx', { ascending: false });
      roomsUl.innerHTML = '';
      data?.forEach(r => {
        const li = document.createElement('li');
        li.textContent = `${r.title}`;
        li.addEventListener('click', () => enterRoom(r.idx, r.youtube_id));
        roomsUl.appendChild(li);
      });
    }

    function showRoomList() {
      roomListDiv.style.display = 'block';
      partyViewDiv.style.display = 'none';
      backButton.style.display = 'none';
      if (commentSub) commentSub.unsubscribe();
      if (syncInterval) clearInterval(syncInterval);
      loadRooms();
    }

    function enterRoom(idx, youtubeId) {
      roomId = idx;
      history.pushState(null, '', `?room=${idx}`);
      roomListDiv.style.display = 'none';
      partyViewDiv.style.display = 'flex';
      backButton.style.display = 'block';
      initPlayer(youtubeId);
      startSyncPolling();
      // 실시간 댓글 구독
      const channel = supabase
        .channel(`room-${roomId}`)
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'comment_list', filter: `watchparty_room_idx=eq.${roomId}` }, () => loadChat())
        .subscribe();
      commentSub = channel;
    }

    async function loadChat() {
      const currentTime = player ? player.getCurrentTime() : 0;
      const { data } = await supabase
        .from('comment_list')
        .select('*')
        .eq('watchparty_room_idx', roomId)
        .lte('timeline', currentTime)
        .order('timeline', { ascending: true });
      chatLog.innerHTML = '';
      if (data) {
        data.forEach(c => {
          const p = document.createElement('p');
          p.textContent = `[${formatTime(c.timeline)}] ${c.nickname}: ${c.comment}`;
          chatLog.appendChild(p);
        });
        chatLog.scrollTop = chatLog.scrollHeight;
      }
    }

    chatSend.addEventListener('click', async () => {
      const text = chatText.value.trim(); if (!text) return;
      await supabase.from('comment_list').insert([{ watchparty_room_idx: roomId, nickname: sessionStorage.getItem('user_nickname'), comment: text, timeline: player ? player.getCurrentTime() : 0 }]);
      chatText.value = '';
      loadChat();
    });

    volumeSlider.addEventListener('input', () => { if (player && player.setVolume) player.setVolume(volumeSlider.value * 100); });

    syncBtn.addEventListener('click', async () => {
      const { data } = await supabase.from('sync').select('timeline, play').eq('watchparty_room_idx', roomId).single();
      if (!player || !data) return;
      player.seekTo(data.timeline, true);
      data.play ? player.playVideo() : player.pauseVideo();
      loadChat();
    });

    function startSyncPolling() {
      if (syncInterval) clearInterval(syncInterval);
      syncInterval = setInterval(async () => {
        const { data } = await supabase.from('sync').select('timeline, play').eq('watchparty_room_idx', roomId).single();
        if (!player || !data) return;
        const current = player.getCurrentTime();
        if (Math.abs(current - data.timeline) > 1) {
          player.seekTo(data.timeline, true);
          data.play ? player.playVideo() : player.pauseVideo();
          loadChat();
        }
      }, 2000);
    }

    window.addEventListener('DOMContentLoaded', () => {
      askNickname();
      const params = new URLSearchParams(location.search);
      const r = params.get('room');
      if (r) supabase.from('watchparty_room').select('youtube_id').eq('idx', r).single().then(({ data }) => { if (data) enterRoom(r, data.youtube_id); });
      else {
        showRoomList();
      }
    });

    window.addEventListener('popstate', () => { if (!location.search.includes('room=')) showRoomList(); });
  </script>
</body>
</html>